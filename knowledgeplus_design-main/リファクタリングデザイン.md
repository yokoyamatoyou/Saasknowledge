### **1\. 基本方針 (Basic Philosophy)**

* **MVPファースト (MVP First):** 本計画の最優先事項は、ローカル環境で完全に動作するMVPを確立すること。すべての設計と実装は、このMVPの実現に焦点を当てる。MNPといて検証を行った後はGoogleクラウドでデプロイを行うのでその前提のファイル構成にすること。  
* **役割の分離 (Role-Based Interface):** UIを「チャット利用」と「ナレッジ管理」で明確に分離する。  
* **状態の保持 (Stateful Experience):** Streamlitのsession\_stateとローカルファイルシステムを組み合わせ、ユーザーが快適に作業を継続できる体験を提供する。

### **2\. UI/UX再設計 (UI/UX Redesign)**

シングルページアプリケーション構造を維持しつつ、ユーザーがより直感的に操作できるよう、UIの配置と機能を洗練させる。
イラストアイコンは禁止、線や丸のみでアイコンや区画分けを行う、ファビコンも抽象的デザインとする。
#### **a. 全体構造**

サイドバーは「対話履歴」と「各種設定」に特化。メインコンテンツは常に画面下部に入力欄が固定された、広々としたチャットエリアと管理画面で構成される。

\+--------------------------------------------------------------------------+  
|                                                                          |  
|  サイドバー (対話履歴と設定)               メインコンテンツ (表示エリア)    |  
|  \+-------------------------+         \+-----------------------------------+  
|  |                         |         |                                   |  
|  | \[ \+ 新しいチャット \]    |         | (チャット or 管理画面)            |  
|  | \----------------------- |         |                                   |  
|  | \[ 過去の会話タイトル1 \] |  \-----\> | (チャットエリアは最大限広く確保)    |  
|  | \[ 過去の会話タイトル2 \] |         |                                   |  
|  | ...                     |         |                                   |  
|  | \----------------------- |         |                                   |  
|  | \[ ⚙️ 管理画面を開く \]   |         |                                   |  
|  | \[▶ チャット設定\]        |         |                                   |  
|  | \[▶ プロンプトアドバイス\]|         |                                   |  
|  \+-------------------------+         \+-----------------------------------+  
|                                      | \[入力欄は常に画面下部に配置\]      |  
\+--------------------------------------------------------------------------+

#### **b. チャット画面 (Chat View)**

**\[更新\]** チャット表示領域を最大化。ナレッジ検索は、利用可能な**すべてのナレッジ**を対象とするシンプルなチェックボックスに。

\+--------------------------------------------------------------------------+  
| \[サイドバー\] | 💬 {ここに会話タイトル}                                    |  
|              |------------------------------------------------------------|  
|              |                                                            |  
|              |   (チャット履歴がここに表示される)                       |  
|              |   (表示領域は最大限広く確保する)                         |  
|              |                                                            |  
|              |                                                            |  
|              |                                                            |  
|              |                                                            |  
|              |                                                            |  
|              |                                                            |  
|              |                                                            |  
|              |                                                            |  
|              |------------------------------------------------------------|  
|              | \[☑ 全てのナレッジから検索する\]                           |  
|              |------------------------------------------------------------|  
|              | \[ここに質問を入力してください...                        ^\] |  
\+--------------------------------------------------------------------------+

#### **c. チャット設定 (Chat Settings in Sidebar)**

**\[更新\]** ペルソナ、温度設定に加え、新機能「プロンプトアドバイス」を**デフォルトで折りたたんだ状態**で追加。

\+--------------------------+  
| \[ \+ 新しいチャット \]     |  
| \------------------------ |  
| \[ 過去の会話タイトル1 \]  |  
| ...                      |  
| \------------------------ |  
| \[ ⚙️ 管理画面を開く \]    |  
|                          |  
| \[▶ チャット設定\]         |  \<-- st.expander(expanded=False)  
|    (ペルソナ, 温度)      |  
|                          |  
| \[▶ プロンプトアドバイス\] |  \<-- st.expander(expanded=False)  
|    \[ \] アドバイスを有効化|  
\+--------------------------+

#### **d. 管理画面 (Admin View)**

サイドバーの「管理画面を開く」ボタンで表示を切り替える。ナレッジ作成とFAQ生成をタブで明確に分離する。ナレッジの作成はテキストとマルチモーダルだったものを統一、同一アップロードボタンでGPT4.1miniが内容、ファイル形式を確認を行い、以前のマルチモーダルか、テキストかの判定を行いチャンク分けからベクトル化、インデックス化まで行う。ナレッジごとに保存する機能は現在と同じ。DocxやPDFに画像が含まれている場合は、文脈と画像でメタデータを作成する、このアルゴリズムを考えてください。

\+--------------------------------------------------------------------------+  
| \[サイドバー\] | 🛠️ ナレッジ・FAQ管理                                       |  
|              |------------------------------------------------------------|  
|              | \[ ナレッジベース構築 \] \[ FAQ自動生成 \]                     |  \<-- st.tabs  
|              |------------------------------------------------------------|  
|              |                                                            |  
|              |  (選択されたタブのコンテンツが表示される)                  |  
|              |                                                            |  
\+--------------------------------------------------------------------------+

### **3\. 機能実装要件 (Functional Implementation Requirements) \- MVP版**

#### **a. 対話履歴の管理 (ローカル保存)**

* **保存場所:** リポジトリ内に ./chat\_history ディレクトリを作成し、すべての対話履歴をここに保存する。  
* **ファイル形式:** 各対話は、一意のID（例：タイムスタンプ or UUID）をファイル名とするJSONファイルで管理する (1677654321.json)。  
* **JSON構造:**  
  {  
    "title": "会話の自動生成タイトル",  
    "created\_at": "2025-06-30 20:30:00",  
    "settings": {  
      "persona": "専門家",  
      "temperature": 0.7,  
      "prompt\_advice": false   
    },  
    "messages": \[  
      {"role": "user", "content": "こんにちは。"},  
      {"role": "assistant", "content": "こんにちは。"}  
    \]  
  }

* **タイトル自動生成:**  
  1. ユーザーの最初の質問とAIの最初の応答（1ターン）が完了した時点で、その内容を軽量・高速なモデル（例：Gemini 1.5 Flash）に渡す。  
  2. プロンプト: 以下の対話内容を5〜10単語程度の簡潔なタイトルにしてください:\\n\\n{対話内容}  
  3. 生成されたタイトルをJSONファイルのtitleキーに保存し、サイドバーの表示を更新する。  
* **アプリ起動時の動作:** 起動時に./chat\_historyをスキャンし、JSONファイル一覧を読み込んでサイドバーに対話履歴リストを構築する。

#### **b. 統合チャット機能**

* **ナレッジ検索の切り替え:**  
  * st.checkbox("全てのナレッジから検索する")の値をst.session\_state.use\_knowledge\_search（ブール値）に格納する。  
  * **Trueの場合:** RAGパイプラインを呼び出す際、利用可能な**すべてのナレッジベース**を検索対象とする。  
  * **Falseの場合:** 標準のチャット補完APIを直接呼び出す。  
  * ナレッジ検索を選択した場合、温度は0.2に変更。

#### **c. プロンプトアドバイス機能**

* **トリガー:** サイドバーのst.expander("プロンプトアドバイス")内にあるst.checkbox("アドバイスを有効化")の状態で判断する。  
* **実行プロセス:**  
  1. ユーザーが質問を送信した際、まず「アドバイスを有効化」がチェックされているか確認する。  
  2. **Trueの場合:**  
     * ユーザーのプロンプトを、メインの応答生成AIとは別のGPTモデル（例：GPT-4o mini）に送信する。  
     * プロンプト: 以下のユーザープロンプトを、より明確で効果的なプロンプトにするための改善案を、簡潔な箇条書きのMarkdown形式で提案してください:\\n\\n---\\n{ユーザーのプロンプト}\\n---  
     * GPTからの改善案（アドバイス）を、チャット履歴に**情報メッセージとして**追加する。  
  3. ユーザーの元のプロンプトを、メインの応答生成AIに送信し、通常の回答を生成する。  
* **アドバイスの表示場所:** ユーザーの質問のすぐ下に、情報ボックス（st.info）や引用ブロックとして表示し、AIの最終的な回答と明確に区別する。  
  (User) AIについて教えて。

  \> 💡 プロンプトアドバイス:  
  \> \* 「AIのどのような側面（歴史、技術、倫理的問題など）について知りたいですか？」のように、焦点を絞るとより的確な回答が得られます。

  (AI) AI（人工知能）についてですね。どの側面にご興味がありますか？...

#### **d. 管理機能**

* 「ナレッジ作成」と「FAQ生成」は、unified\_app.pyやmm\_kb\_builder/app.pyに存在するロジックを、管理画面の各タブ内に再配置・統合する。

### **4\. 実行計画とGeminiの役割 (Execution Plan & Gemini's Role)**

このリファクタリングは、以下のステップで実行します。

1. **ステップ1: Geminiによるコード生成**  
   * 私が、本計画書に基づいてUIとロジックを再構築した単一のPythonファイル (app.py) を生成します。  
   * このファイルは、Streamlitの特性を最大限に活かし、セッション管理やUIの動的更新を適切に行います。Streamlitのコンポーネントを素直に組み合わせることで、チャット表示枠を広く確保し、入力欄が自然に画面下部に配置されるレイアウトを実現します。複雑なCSSハックは保守性を損なうため、MVPでは避けます。  
2. **ステップ2: ユーザーによる実行**  
   * **協力のお願い:** 私にはコードを実行する能力がありません。そのため、以下のコマンドを**あなたのローカルPCのターミナルで実行していただく必要があります。**  
     streamlit run app.py

3. **シェルスクリプト (run\_app.sh) について**  
   * streamlit run コマンドは、Webサーバーを起動するコマンドです。このサーバーは、ユーザーがブラウザでアクセスするために、**常に待機状態（実行し続ける状態）になるのが正常な動作**です。シェルが終了しないのはエラーではありません。  コーディング時に待機状態が永続的に発生するのを防いでください。

**結論として、Gemini（私）はリファクタリングされたコードの完全な生成までを担当し、その後の起動・実行はユーザー様にお願いする、という連携で進めさせていただきます。**
